name: Build & Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Version override (leave empty to use version.yaml)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  # Job 1: Build libcore.dll (Linux Docker, cross-compile for Windows via mingw)
  build-libcore:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build libcore.dll (cached)
        uses: docker/build-push-action@v6
        with:
          context: libcore
          file: libcore/Dockerfile.windows
          tags: hiddify-libcore-builder:latest
          load: true
          cache-from: type=gha,scope=libcore
          cache-to: type=gha,mode=max,scope=libcore

      - name: Extract libcore.dll
        working-directory: libcore
        run: |
          mkdir -p bin
          docker run --rm -v "$(pwd)/bin:/output" hiddify-libcore-builder:latest cp /out/libcore.dll /output/

      - name: Verify libcore.dll
        run: |
          ls -la libcore/bin/libcore.dll
          file libcore/bin/libcore.dll

      - uses: actions/upload-artifact@v4
        with:
          name: libcore
          path: libcore/bin/libcore.dll
          retention-days: 1

  # Job 2: Build xray-core.exe (Linux Docker)
  build-xray:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build xray-core.exe (cached)
        uses: docker/build-push-action@v6
        with:
          context: libcore
          file: libcore/Dockerfile.xray
          tags: hiddify-xray-builder:latest
          load: true
          cache-from: type=gha,scope=xray
          cache-to: type=gha,mode=max,scope=xray

      - name: Extract xray-core.exe
        working-directory: libcore
        run: |
          mkdir -p bin
          docker run --rm -v "$(pwd)/bin:/output" hiddify-xray-builder:latest cp /xray-core.exe /output/

      - name: Verify xray-core.exe
        run: |
          ls -la libcore/bin/xray-core.exe
          file libcore/bin/xray-core.exe

      - uses: actions/upload-artifact@v4
        with:
          name: xray-core
          path: libcore/bin/xray-core.exe
          retention-days: 1

  # Job 3: Build Flutter Windows app
  build-flutter:
    runs-on: windows-latest
    needs: [build-libcore, build-xray]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Read version
        id: version
        shell: bash
        run: |
          if [ -n "${{ inputs.version_override }}" ]; then
            echo "version=${{ inputs.version_override }}" >> "$GITHUB_OUTPUT"
          else
            HIDDIFY_BASE=$(grep 'hiddify_base:' version.yaml | sed 's/.*: *"\(.*\)"/\1/')
            YUMASH_VERSION=$(grep 'yumash_version:' version.yaml | sed 's/.*: *"\(.*\)"/\1/')
            echo "version=${HIDDIFY_BASE}-yumash-${YUMASH_VERSION}" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\Pub\Cache
            .dart_tool
          key: pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: pub-

      - name: Download libcore.dll
        uses: actions/download-artifact@v4
        with:
          name: libcore
          path: libcore/bin/

      - name: Download xray-core.exe
        uses: actions/download-artifact@v4
        with:
          name: xray-core
          path: libcore/bin/

      - name: Flutter setup
        run: |
          dart --disable-analytics
          flutter config --no-analytics
          flutter pub get

      - name: Code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Windows
        run: flutter build windows --target=lib/main_prod.dart

      - name: Assemble release
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_DIR="release/${VERSION}/${VERSION}"
          mkdir -p "${RELEASE_DIR}"

          # Copy Flutter build output
          cp -r build/windows/x64/runner/Release/* "${RELEASE_DIR}/"

          # Copy native binaries
          cp libcore/bin/libcore.dll "${RELEASE_DIR}/"
          cp libcore/bin/xray-core.exe "${RELEASE_DIR}/"

          # Copy plugin DLLs
          for dir in build/windows/x64/plugins/*/Release; do
            if [ -d "$dir" ]; then
              cp "$dir"/*.dll "${RELEASE_DIR}/" 2>/dev/null || true
            fi
          done

          # Copy sqlite3.dll specifically
          if [ -f "build/windows/x64/plugins/sqlite3_flutter_libs/Release/sqlite3.dll" ]; then
            cp "build/windows/x64/plugins/sqlite3_flutter_libs/Release/sqlite3.dll" "${RELEASE_DIR}/"
          fi

          # Copy version file
          cp version.yaml "${RELEASE_DIR}/"

      - name: Create ZIP
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $RELEASE_DIR = "release/${VERSION}/${VERSION}"
          $ZIP_PATH = "release/${VERSION}/Hiddify-Yumash-${VERSION}-windows-x64.zip"
          Compress-Archive -Path "${RELEASE_DIR}/*" -DestinationPath $ZIP_PATH -Force

      - name: Generate MD5
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $ZIP_PATH = "release/${VERSION}/Hiddify-Yumash-${VERSION}-windows-x64.zip"
          $ZIP_NAME = "Hiddify-Yumash-${VERSION}-windows-x64.zip"
          $MD5_FILE = "release/${VERSION}/${ZIP_NAME}.md5"
          $hash = (Get-FileHash -Path $ZIP_PATH -Algorithm MD5).Hash.ToLower()
          "${hash}  ${ZIP_NAME}" | Set-Content -Path $MD5_FILE -NoNewline

      - uses: actions/upload-artifact@v4
        with:
          name: release
          path: |
            release/${{ steps.version.outputs.version }}/Hiddify-Yumash-${{ steps.version.outputs.version }}-windows-x64.zip
            release/${{ steps.version.outputs.version }}/Hiddify-Yumash-${{ steps.version.outputs.version }}-windows-x64.zip.md5
          retention-days: 5

    outputs:
      version: ${{ steps.version.outputs.version }}

  # Job 4: Create tag and GitHub Release
  release:
    runs-on: ubuntu-latest
    needs: build-flutter
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tag exists
        id: check_tag
        run: |
          VERSION="v${{ needs.build-flutter.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
          echo "tag=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ needs.build-flutter.outputs.version }}"
          # Extract section for current version from CHANGELOG.md
          # Grab everything between "## [VERSION]" and the next "## [" or "---"
          BODY=$(awk "/^## \\[${VERSION}\\]/{found=1; next} found && /^(## \\[|---)/{exit} found{print}" CHANGELOG.md)
          if [ -z "$BODY" ]; then
            BODY="No changelog entry found for ${VERSION}."
          fi
          # Write to file to avoid multiline output issues
          cat > release_body.md << INNEREOF
          ## Hiddify Yumash Edition ${VERSION}

          ### Установка / Installation
          1. Скачайте \`Hiddify-Yumash-${VERSION}-windows-x64.zip\`
          2. Распакуйте в любую папку / Extract to any folder
          3. Запустите \`Hiddify.exe\` / Run \`Hiddify.exe\`

          > Настройки хранятся в \`portable_data/\` рядом с exe.

          ---

          ${BODY}
          INNEREOF

      - name: Create tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          git tag "${{ steps.check_tag.outputs.tag }}"
          git push origin "${{ steps.check_tag.outputs.tag }}"

      - name: Download release artifacts
        if: steps.check_tag.outputs.exists == 'false' || startsWith(github.ref, 'refs/tags/v')
        uses: actions/download-artifact@v4
        with:
          name: release
          path: artifacts/

      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false' || startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.check_tag.outputs.tag }}
          name: "Hiddify Yumash Edition ${{ needs.build-flutter.outputs.version }}"
          body_path: release_body.md
          files: |
            artifacts/**/*.zip
            artifacts/**/*.md5
          draft: false
          prerelease: false
